!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).SecureDfu=e()}}(function(){return function e(t,n,r){function i(s,a){if(!n[s]){if(!t[s]){var c="function"==typeof require&&require;if(!a&&c)return c(s,!0);if(o)return o(s,!0);var u=new Error("Cannot find module '"+s+"'");throw u.code="MODULE_NOT_FOUND",u}var h=n[s]={exports:{}};t[s][0].call(h.exports,function(e){var n=t[s][1][e];return i(n||e)},h,h.exports,e,t,n,r)}return n[s].exports}for(var o="function"==typeof require&&require,s=0;s<r.length;s++)i(r[s]);return i}({1:[function(e,t,n){"use strict";var r=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){e(t,n);function r(){this.constructor=t}t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}();Object.defineProperty(n,"__esModule",{value:!0});var i=function(e){r(t,e);function t(){return null!==e&&e.apply(this,arguments)||this}return t.prototype.addEventListener=function(t,n){return e.prototype.addListener.call(this,t,n)},t.prototype.removeEventListener=function(t,n){return e.prototype.removeListener.call(this,t,n)},t.prototype.dispatchEvent=function(t,n){return e.prototype.emit.call(this,t,n)},t}(e("events").EventEmitter);n.EventDispatcher=i},{events:4}],2:[function(e,t,n){"use strict";var r=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){e(t,n);function r(){this.constructor=t}t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}();Object.defineProperty(n,"__esModule",{value:!0});var i="8ec90001-f315-4f60-9fb8-838830daea50",o="8ec90002-f315-4f60-9fb8-838830daea50",s={BUTTON_COMMAND:[1],CREATE_COMMAND:[1,1],CREATE_DATA:[1,2],RECEIPT_NOTIFICATIONS:[2],CACULATE_CHECKSUM:[3],EXECUTE:[4],SELECT_COMMAND:[6,1],SELECT_DATA:[6,2],RESPONSE:[96,32]},a={0:"Invalid opcode",1:"Operation successful",2:"Opcode not supported",3:"Missing or invalid parameter value",4:"Not enough memory for the data object",5:"Data object does not match the firmware and hardware requirements, the signature is wrong, or parsing the command failed",7:"Not a valid object type for a Create request",8:"The state of the DFU process does not allow this operation",10:"Operation failed",11:"Extended error"},c={0:"No extended error code has been set. This error indicates an implementation problem",1:"Invalid error code. This error code should never be used outside of development",2:"The format of the command was incorrect",3:"The command was successfully parsed, but it is not supported or unknown",4:"The init command is invalid. The init packet either has an invalid update type or it is missing required fields for the update type",5:"The firmware version is too low. For an application, the version must be greater than the current application. For a bootloader, it must be greater than or equal to the current version",6:"The hardware version of the device does not match the required hardware version for the update",7:"The array of supported SoftDevices for the update does not contain the FWID of the current SoftDevice",8:"The init packet does not contain a signature",9:"The hash type that is specified by the init packet is not supported by the DFU bootloader",10:"The hash of the firmware image cannot be calculated",11:"The type of the signature is unknown or not supported by the DFU bootloader",12:"The hash of the received firmware image does not match the hash in the init packet",13:"The available space on the device is insufficient to hold the firmware"},u=function(e){r(t,e);function t(t,n){var r=e.call(this)||this;return r.crc32=t,r.bluetooth=n,r.notifyFns={},r.controlChar=null,r.packetChar=null,!r.bluetooth&&window&&window.navigator&&window.navigator.bluetooth&&(r.bluetooth=navigator.bluetooth),r}return t.prototype.log=function(e){this.dispatchEvent(t.EVENT_LOG,{message:e})},t.prototype.progress=function(e){this.dispatchEvent(t.EVENT_PROGRESS,{object:"unknown",totalBytes:0,currentBytes:e})},t.prototype.connect=function(e){var t=this;return e.addEventListener("gattserverdisconnected",function(){t.notifyFns={},t.controlChar=null,t.packetChar=null}),this.gattConnect(e).then(function(e){if(t.log("found "+e.length+" characteristic(s)"),t.packetChar=e.find(function(e){return e.uuid===o}),!t.packetChar)throw new Error("Unable to find packet characteristic");if(t.log("found packet characteristic"),t.controlChar=e.find(function(e){return e.uuid===i}),!t.controlChar)throw new Error("Unable to find control characteristic");if(t.log("found control characteristic"),!t.controlChar.properties.notify&&!t.controlChar.properties.indicate)throw new Error("Control characteristic does not allow notifications");return t.controlChar.startNotifications()}).then(function(){return t.controlChar.addEventListener("characteristicvaluechanged",t.handleNotification.bind(t)),t.log("enabled control notifications"),e})},t.prototype.gattConnect=function(e){var n=this;return Promise.resolve().then(function(){return e.gatt.connected?e.gatt:e.gatt.connect()}).then(function(e){return n.log("connected to gatt server"),e.getPrimaryService(t.SERVICE_UUID).catch(function(){throw new Error("Unable to find DFU service")})}).then(function(e){return n.log("found DFU service"),e.getCharacteristics()})},t.prototype.handleNotification=function(e){var t=e.target.value;if(s.RESPONSE.indexOf(t.getUint8(0))<0)throw new Error("Unrecognised control characteristic response notification");var n=t.getUint8(1);if(this.notifyFns[n]){var r=t.getUint8(2),i=null;if(1===r){var o=new DataView(t.buffer,3);this.notifyFns[n].resolve(o)}else if(11===r){var u=t.getUint8(3);i="Error: "+c[u]}else i="Error: "+a[r];i&&(this.log("notify: "+i),this.notifyFns[n].reject(i)),delete this.notifyFns[n]}},t.prototype.sendOperation=function(e,t,n){var r=this;return new Promise(function(i,o){var s=t.length;n&&(s+=n.byteLength);var a=new Uint8Array(s);if(a.set(t),n){var c=new Uint8Array(n);a.set(c,t.length)}r.notifyFns[t[0]]={resolve:i,reject:o},e.writeValue(a)})},t.prototype.sendControl=function(e,t){return this.sendOperation(this.controlChar,e,t)},t.prototype.transferInit=function(e){return this.transfer(e,"init",s.SELECT_COMMAND,s.CREATE_COMMAND)},t.prototype.transferFirmware=function(e){return this.transfer(e,"firmware",s.SELECT_DATA,s.CREATE_DATA)},t.prototype.transfer=function(e,n,r,i){var o=this;return this.sendControl(r).then(function(r){var s=r.getUint32(0,!0),a=r.getUint32(4,!0),c=r.getInt32(8,!0);if("init"!==n||a!==e.byteLength||!o.checkCrc(e,c))return o.progress=function(r){o.dispatchEvent(t.EVENT_PROGRESS,{object:n,totalBytes:e.byteLength,currentBytes:r})},o.progress(0),o.transferObject(e,i,s,a);o.log("init packet already available, skipping transfer")})},t.prototype.transferObject=function(e,t,n,r){var i=this,o=r-r%n,a=Math.min(o+n,e.byteLength),c=new DataView(new ArrayBuffer(4));return c.setUint32(0,a-o,!0),this.sendControl(t,c.buffer).then(function(){var t=e.slice(o,a);return i.transferData(t,o)}).then(function(){return i.sendControl(s.CACULATE_CHECKSUM)}).then(function(t){var n=t.getInt32(4,!0),o=t.getUint32(0,!0),a=e.slice(0,o);if(i.checkCrc(a,n))return i.log("written "+o+" bytes"),r=o,i.sendControl(s.EXECUTE);i.log("object failed to validate")}).then(function(){if(a<e.byteLength)return i.transferObject(e,t,n,r);i.log("transfer complete")})},t.prototype.transferData=function(e,t,n){var r=this;n=n||0;var i=Math.min(n+20,e.byteLength),o=e.slice(n,i);return this.packetChar.writeValue(o).then(function(){if(r.progress(t+i),i<e.byteLength)return r.transferData(e,t,i)})},t.prototype.checkCrc=function(e,t){return this.crc32?t===this.crc32(new Uint8Array(e)):(this.log("crc32 not found, skipping CRC check"),!0)},t.prototype.requestDevice=function(e,n){var r=this;e||n||(n=[{services:[t.SERVICE_UUID]}]);var i={optionalServices:[t.SERVICE_UUID]};return n?i.filters=n:i.acceptAllDevices=!0,this.bluetooth.requestDevice(i).then(function(t){return e?r.setDfuMode(t):t})},t.prototype.setDfuMode=function(e){var t=this;return this.gattConnect(e).then(function(n){t.log("found "+n.length+" characteristic(s)");var r=n.find(function(e){return e.uuid===i}),a=n.find(function(e){return e.uuid===o});if(r&&a)return e;var c=n.find(function(e){return"8ec90003-f315-4f60-9fb8-838830daea50"===e.uuid});if(!c)throw new Error("Unsupported device");if(t.log("found buttonless characteristic"),!c.properties.notify&&!c.properties.indicate)throw new Error("Buttonless characteristic does not allow notifications");return new Promise(function(n,r){function i(){this.notifyFns={},n(null)}c.startNotifications().then(function(){return t.log("enabled buttonless notifications"),e.addEventListener("gattserverdisconnected",i.bind(t)),c.addEventListener("characteristicvaluechanged",t.handleNotification.bind(t)),t.sendOperation(c,s.BUTTON_COMMAND)}).then(function(){t.log("sent DFU mode"),i()})})})},t.prototype.update=function(e,t,n){var r=this;return new Promise(function(i,o){return e?t?n?void r.connect(e).then(function(){return r.log("transferring init"),r.transferInit(t)}).then(function(){return r.log("transferring firmware"),r.transferFirmware(n)}).then(function(){r.log("complete, disconnecting..."),e.addEventListener("gattserverdisconnected",function(){r.log("disconnected"),i(e)})}).catch(function(e){return o(e)}):o("Firmware not specified"):o("Init not specified"):o("Device not specified")})},t.SERVICE_UUID=65113,t.EVENT_LOG="log",t.EVENT_PROGRESS="progress",t}(e("./dispatcher").EventDispatcher);n.SecureDfu=u},{"./dispatcher":1}],3:[function(e,t,n){"use strict";var r=e("./secure-dfu");t.exports=r.SecureDfu},{"./secure-dfu":2}],4:[function(e,t,n){function r(){this._events=this._events||{},this._maxListeners=this._maxListeners||void 0}t.exports=r,r.EventEmitter=r,r.prototype._events=void 0,r.prototype._maxListeners=void 0,r.defaultMaxListeners=10,r.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||isNaN(e))throw TypeError("n must be a positive number");return this._maxListeners=e,this},r.prototype.emit=function(e){var t,n,r,a,c,u;if(this._events||(this._events={}),"error"===e&&(!this._events.error||o(this._events.error)&&!this._events.error.length)){if((t=arguments[1])instanceof Error)throw t;var h=new Error('Uncaught, unspecified "error" event. ('+t+")");throw h.context=t,h}if(s(n=this._events[e]))return!1;if(i(n))switch(arguments.length){case 1:n.call(this);break;case 2:n.call(this,arguments[1]);break;case 3:n.call(this,arguments[1],arguments[2]);break;default:a=Array.prototype.slice.call(arguments,1),n.apply(this,a)}else if(o(n))for(a=Array.prototype.slice.call(arguments,1),r=(u=n.slice()).length,c=0;c<r;c++)u[c].apply(this,a);return!0},r.prototype.addListener=function(e,t){var n;if(!i(t))throw TypeError("listener must be a function");return this._events||(this._events={}),this._events.newListener&&this.emit("newListener",e,i(t.listener)?t.listener:t),this._events[e]?o(this._events[e])?this._events[e].push(t):this._events[e]=[this._events[e],t]:this._events[e]=t,o(this._events[e])&&!this._events[e].warned&&(n=s(this._maxListeners)?r.defaultMaxListeners:this._maxListeners)&&n>0&&this._events[e].length>n&&(this._events[e].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[e].length),"function"==typeof console.trace&&console.trace()),this},r.prototype.on=r.prototype.addListener,r.prototype.once=function(e,t){if(!i(t))throw TypeError("listener must be a function");var n=!1;function r(){this.removeListener(e,r),n||(n=!0,t.apply(this,arguments))}return r.listener=t,this.on(e,r),this},r.prototype.removeListener=function(e,t){var n,r,s,a;if(!i(t))throw TypeError("listener must be a function");if(!this._events||!this._events[e])return this;if(s=(n=this._events[e]).length,r=-1,n===t||i(n.listener)&&n.listener===t)delete this._events[e],this._events.removeListener&&this.emit("removeListener",e,t);else if(o(n)){for(a=s;a-- >0;)if(n[a]===t||n[a].listener&&n[a].listener===t){r=a;break}if(r<0)return this;1===n.length?(n.length=0,delete this._events[e]):n.splice(r,1),this._events.removeListener&&this.emit("removeListener",e,t)}return this},r.prototype.removeAllListeners=function(e){var t,n;if(!this._events)return this;if(!this._events.removeListener)return 0===arguments.length?this._events={}:this._events[e]&&delete this._events[e],this;if(0===arguments.length){for(t in this._events)"removeListener"!==t&&this.removeAllListeners(t);return this.removeAllListeners("removeListener"),this._events={},this}if(i(n=this._events[e]))this.removeListener(e,n);else if(n)for(;n.length;)this.removeListener(e,n[n.length-1]);return delete this._events[e],this},r.prototype.listeners=function(e){return this._events&&this._events[e]?i(this._events[e])?[this._events[e]]:this._events[e].slice():[]},r.prototype.listenerCount=function(e){if(this._events){var t=this._events[e];if(i(t))return 1;if(t)return t.length}return 0},r.listenerCount=function(e,t){return e.listenerCount(t)};function i(e){return"function"==typeof e}function o(e){return"object"==typeof e&&null!==e}function s(e){return void 0===e}},{}]},{},[3])(3)});
//# sourceMappingURL=secure-dfu.js.map
